<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>発注・配分ワークフロー (金額合計表示)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/datatables.net-dt@1.13.6/css/jquery.dataTables.min.css" rel="stylesheet"/>
  <style>
    body { padding: 20px; }
    .step-content { margin-top: 20px; }
    #order-table_wrapper { margin-top: 10px; }
    .drag-drop-list, .dropzone { min-height: 200px; border: 1px dashed #aaa; padding: 10px; }
    .item { padding: 5px; margin: 5px 0; background: #f8f9fa; border: 1px solid #ddd; cursor: grab; }
    .item.selected { background: #cfe2ff; border-color: #6c757d; }
    .packet-container { display: flex; gap: 10px; flex-wrap: wrap; }
    .packet { border: 1px solid #ccc; border-radius: 4px; padding: 5px; width: 220px; }
    .packet h6 { margin: 0 0 5px; cursor: text; }
    .packet .sum { margin-top: 5px; font-weight: bold; }
    #step2 .col-9 {
      max-height: 60vh;
      overflow-y: auto;
      padding-bottom: 15px;
    }
    /* 上部ページネーションのスタイル調整例 */
    #order-table_wrapper .top-pagination {
        /* margin-left: auto; /* 右寄せにする場合 */
        display: inline-block; /* 他のコントロールと並べる場合 */
        margin: 0 10px; /* 適宜マージン調整 */
    }
    /* DataTablesのデフォルトの .row の中の要素配置に合わせる */
    #order-table_wrapper .dataTables_length,
    #order-table_wrapper .dataTables_filter,
    #order-table_wrapper .top-pagination {
        margin-bottom: 0.5em; /* Bootstrapのrow内の要素に合わせる */
    }
  </style>
</head>
<body>
  <h1>発注・配分ワークフロー (金額合計表示)</h1>
  <input type="file" id="file-input" accept=".csv,.xlsx,.xls" class="form-control mb-3" multiple/>
  <ul class="nav nav-tabs" id="workflowTabs">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#step1">ステップ1: 発注数量入力</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#step2">ステップ2: パケット配分</a></li>
  </ul>
  <div class="tab-content step-content">
    <div class="tab-pane fade show active" id="step1">
      <div class="mb-2">
        対象店舗:
        <select id="store-select" class="form-select d-inline-block" style="width:auto;"></select>
        <button id="to-step2" class="btn btn-primary ms-3">次へ</button>
      </div>
      <table id="order-table" class="display" style="width:100%">
        <thead>
          <tr>
            <th>取得ファイル名</th>
            <th>伝票日付</th><th>チラシ日</th><th>売価開始日</th><th>売価終了日</th>
            <th>重要度</th><th>部門</th><th>JAN</th><th>メーカー名</th><th>商品名</th>
            <th>規格</th><th>発注単位</th><th>原価</th><th>本体売価</th><th>総額売価</th>
            <th>税率</th><th>値入率</th><th>備考</th><th>提案数量</th><th>発注数量</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="tab-pane fade" id="step2">
      <div class="d-flex justify-content-between align-items-center">
        <h5>発注数量をドラッグ＆ドロップでパケットへ配分</h5>
        <div class="mt-3 d-flex align-items-center gap-2">
          <button id="add-packet" class="btn btn-success btn-sm">パケット追加</button>
          <button id="load-packet-config" class="btn btn-info btn-sm">構成読込</button>
          <input type="file" id="load-packet-config-input" accept=".json" style="display: none;">
          <button id="save-packet-config" class="btn btn-primary btn-sm">構成保存</button>
          <button id="download-csv" class="btn btn-secondary btn-sm">CSVダウンロード</button>
        </div>
      </div>
      <div class="row mt-3">
        <div class="col-3">
          <h6>商品リスト</h6>
          <div id="allocation-list" class="drag-drop-list"></div>
        </div>
        <div class="col-9">
          <div class="packet-container" id="packets"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/datatables.net@1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/plugins/SortableMultiDrag.min.js"></script>

  <script>
    if (typeof Sortable !== 'undefined' && typeof Sortable.MultiDrag === 'function') {
        Sortable.mount(new Sortable.MultiDrag());
        console.log("Sortable.MultiDrag mounted successfully.");
    } else {
        console.warn("Sortable or Sortable.MultiDrag is not available. Multi-drag functionality might be affected.");
    }

    const detailKeys = ['取得ファイル名', '伝票日付','チラシ日','売価開始日','売価終了日','重要度','部門','JAN','メーカー名','商品名','規格','発注単位','原価','本体売価','総額売価','税率','値入率','備考'];
    let dataRows = [], storeCols = [], orderTable, allocationItems = [], packets = [];
    const localStorageKey = 'workflowPacketConfig';

    function initializePacketsFromStorage() {
        const savedPacketConfigJson = localStorage.getItem(localStorageKey);
        if (savedPacketConfigJson) {
            try {
                const savedConfig = JSON.parse(savedPacketConfigJson);
                if (savedConfig && Array.isArray(savedConfig.packetNames)) {
                    packets = [...savedConfig.packetNames];
                } else { packets = ['パケットA','パケットB','パケットC']; }
            } catch (e) {
                packets = ['パケットA','パケットB','パケットC'];
                localStorage.removeItem(localStorageKey);
            }
        } else { packets = ['パケットA','パケットB','パケットC']; }
    }
    initializePacketsFromStorage();

    orderTable = $('#order-table').DataTable({
        columns: detailKeys.map(() => ({})).concat([{}, {}]), // ★ カンマを追加
        dom: 'lfrtip', 
        initComplete: function () {
            var $tableContainer = $(this.api().table().container());
            var $paginate = $tableContainer.find('.dataTables_paginate');
            // DataTablesは通常、コントロールを <div class="row"><div class="col-sm-12 col-md-X">...</div></div> のような構造でラップする
            // .dataTables_length と .dataTables_filter は通常同じ .row の中にある
            var $topControlsRow = $tableContainer.find('.dataTables_length').closest('.row'); 
            if (!$topControlsRow.length) { // もし .row でラップされていなければ、直接の親を取得
                 $topControlsRow = $tableContainer.find('.dataTables_length').parent();
            }


            if ($paginate.length && $topControlsRow.length) {
                // 既存の複製されたページネーションがあれば削除
                $topControlsRow.find('.top-pagination').remove();
                
                var $clonedPaginate = $paginate.clone(true)
                    .addClass('top-pagination col-sm-12 col-md-auto') // Bootstrapの列クラスを追加してレイアウト調整
                    .css('padding-left', '0').css('padding-right', '0'); // DataTablesのデフォルトpaddingを考慮

                // .dataTables_filter の隣に挿入、または適切な場所に配置
                var $filterDiv = $topControlsRow.find('.dataTables_filter');
                if ($filterDiv.length) {
                    $clonedPaginate.insertAfter($filterDiv);
                } else {
                    var $lengthDiv = $topControlsRow.find('.dataTables_length');
                    if($lengthDiv.length) {
                         $clonedPaginate.insertAfter($lengthDiv);
                    } else {
                        $topControlsRow.append($clonedPaginate); // rowの最後に追加
                    }
                }
                 // BootstrapのFlexboxユーティリティで中央揃えや右寄せも可能
                // $topControlsRow.addClass('justify-content-between'); // 例: lengthとfilter/paginateを両端に
            }
        }
    });

    $('#file-input').on('change', function(e) {
      const files = e.target.files;
      if (!files || files.length === 0) { return; }
      const filePromises = Array.from(files).map(file => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = ev => {
            try {
              let parsedFileContent = [];
              if (file.name.endsWith('.csv')) {
                Papa.parse(ev.target.result, {
                  header: true, skipEmptyLines: true, dynamicTyping: true,
                  complete: res => {
                    if (res.data && res.data.length > 0 && typeof res.data[0] === 'object' && res.data[0] !== null) {
                      parsedFileContent = res.data.map(row => ({ ...row, '取得ファイル名': file.name }));
                    } else { console.warn("CSV不正:", file.name, res); }
                    resolve(parsedFileContent);
                  },
                  error: err => { console.error("CSVエラー:", file.name, err); resolve([]); }
                });
              } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                const wb = XLSX.read(ev.target.result, { type: 'binary' });
                const targetSheetName = "新データ入力"; let ws;
                if (wb.SheetNames.includes(targetSheetName)) { ws = wb.Sheets[targetSheetName]; }
                else { console.warn(`'${file.name}'に'${targetSheetName}'なし`); resolve([]); return; }
                const rowsAsArrays = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '', raw: false });
                let headerRowIndex = -1; let actualHeaders = [];
                const headerCandidateIndices = [5, 6, 7]; 
                for (const idx of headerCandidateIndices) {
                    if (idx < rowsAsArrays.length) {
                        const rowCells = (rowsAsArrays[idx] || []).map(cell => String(cell || '').trim());
                        if (rowCells.includes(detailKeys[1])) { 
                            headerRowIndex = idx; actualHeaders = rowCells;
                            console.log(`'${file.name}', '${targetSheetName}': ヘッダー ${idx + 1}行目`);
                            break; 
                        }
                    }
                }
                if (headerRowIndex === -1) { console.error(`'${file.name}', '${targetSheetName}': ヘッダー見つからず`); resolve([]); return; }
                const dataRowsOnly = rowsAsArrays.slice(headerRowIndex + 1);
                parsedFileContent = dataRowsOnly.map(rowArray => {
                  const obj = { '取得ファイル名': file.name };
                  if (Array.isArray(rowArray)) {
                    actualHeaders.forEach((header, index) => {
                      if (header && header.trim() !== "") { obj[header] = (rowArray[index] !== undefined && rowArray[index] !== null) ? String(rowArray[index]) : ''; }
                    });
                  }
                  return obj;
                }).filter(obj => Object.keys(obj).length > 1 && !Object.values(obj).slice(1).every(val => val === ''));
                resolve(parsedFileContent);
              } else { console.warn("未対応:", file.name); resolve([]); }
            } catch (error) { console.error(`処理エラー (${file.name}):`, error); reject(error); }
          };
          reader.onerror = err => { console.error("Readerエラー:", file.name, err); reject(err); };
          if (file.name.endsWith('.csv')) { reader.readAsText(file); }
          else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) { reader.readAsBinaryString(file); }
          else { alert("未対応形式: " + file.name); resolve([]); }
        });
      });
      Promise.all(filePromises).then(results => {
        const allParsedData = results.reduce((acc, data) => acc.concat(data), []);
        if (allParsedData.length === 0 && files.length > 0) { alert("読込失敗または有効データなし"); }
        handle(allParsedData);
      }).catch(err => { console.error("複数ファイル処理エラー:", err); alert("ファイル処理エラー"); handle([]); });
    });

    const handle = data => {
        console.groupCollapsed("`handle`");
        if (!data || data.length === 0 || typeof data[0] !== 'object' || data[0] === null) {
          alert("読込失敗またはデータ形式不正");
          dataRows = []; storeCols = []; $('#store-select').empty().append('<option value="">--選択--</option>'); orderTable.clear().draw();
          console.groupEnd(); return;
        }
        dataRows = data; const allFileKeys = new Set();
        dataRows.forEach(row => { if (typeof row === 'object' && row !== null) Object.keys(row).forEach(key => allFileKeys.add(String(key).trim())); });
        storeCols = [];
        allFileKeys.forEach(key => { if (!detailKeys.some(dk => dk.trim().toLowerCase() === key.toLowerCase()) && key !== "") storeCols.push(key); });
        const $storeSelect = $('#store-select').empty().append('<option value="">--選択--</option>');
        if (storeCols.length > 0) storeCols.forEach(s => $storeSelect.append(`<option value="${s}">${s}</option>`));
        else console.warn("店舗列なし");
        orderTable.clear().draw(); // ここで一旦クリア＆描画
        console.log("handle function finished, dataRows count:", dataRows.length);
        console.groupEnd();
      };

    $('#store-select').on('change', function(){
      const store = this.value; 
      console.log("Store selected:", store);
      orderTable.clear(); // 選択変更時にクリア
      if(!store || !dataRows || dataRows.length === 0){ 
          console.log("Store or dataRows empty, drawing empty table.");
          orderTable.draw(); return; 
      }
      console.log("Populating table for store:", store, "with", dataRows.length, "rows.");
      dataRows.forEach((r, i) => { // デバッグ用にインデックス追加
        if (typeof r !== 'object' || r === null) {
            console.warn("Invalid row data at index", i, r);
            return;
        }
        const proposalQtyRaw = r[store];
        const proposalQty = (typeof proposalQtyRaw === 'number' || (typeof proposalQtyRaw === 'string' && !isNaN(parseFloat(proposalQtyRaw)))) ? parseFloat(proposalQtyRaw) : 0;
        const unitPrice = parseFloat(r['本体売価'] || 0); const orderUnit = parseFloat(r['発注単位'] || 1);
        let initialOrderQty = proposalQty < 0 ? 0 : proposalQty;
        if (orderUnit > 0 && initialOrderQty > 0 && initialOrderQty % orderUnit !== 0) initialOrderQty = Math.ceil(initialOrderQty / orderUnit) * orderUnit;
        const orderQtyInput = `<input type="number" class="form-control qty-input" min="0" step="${orderUnit > 0 ? orderUnit : 1}" value="${initialOrderQty}" data-price="${unitPrice}" data-order-unit="${orderUnit}"/>`;
        const rowData = detailKeys.map(k => (r[k] !== undefined && r[k] !== null) ? String(r[k]) : '');
        rowData.push(proposalQty, orderQtyInput); 
        try {
            orderTable.row.add(rowData);
        } catch(e) {
            console.error("Error adding row to DataTable:", e, "Row data:", rowData, "Original data:", r);
        }
      });
      console.log("All rows added, drawing table.");
      orderTable.draw();
      console.log("Table drawn.");
    });

    $(document).on('input change blur', '#order-table tbody .qty-input', function(event) {
        const $input = $(this); const orderUnit = parseFloat($input.data('order-unit')) || 1; let currentQty = parseFloat($input.val());
        if (isNaN(currentQty)) { if (event.type === 'blur' && $input.val().trim() === '') $input.val(0); return; }
        if (currentQty < 0) { currentQty = 0; $input.val(0); }
        if (event.type === 'blur' || event.type === 'change') {
            if (orderUnit > 0 && currentQty > 0) { const adj = Math.ceil(currentQty / orderUnit) * orderUnit; if (parseFloat($input.val()) !== adj) $input.val(adj); }
            else if (currentQty === 0) { $input.val(0); }
        }
    });

    $('#to-step2').on('click', function(){
      allocationItems = [];
      orderTable.rows().nodes().to$().each(function() {
        const $row = $(this); const $cells = $row.find('td'); if ($cells.length === 0) return;
        const sourceFileName = $cells.eq(detailKeys.indexOf('取得ファイル名')).text().trim();
        const itemName = $cells.eq(detailKeys.indexOf('商品名')).text().trim();
        const $input = $cells.last().find('input.qty-input'); if ($input.length === 0) return;
        const qty = parseFloat($input.val()) || 0; const price = parseFloat($input.data('price')) || 0;
        if(qty > 0 && itemName && !isNaN(price)) {
            const slipDate = $cells.eq(detailKeys.indexOf('伝票日付')).text().trim();
            const department = $cells.eq(detailKeys.indexOf('部門')).text().trim();
            const jan = $cells.eq(detailKeys.indexOf('JAN')).text().trim();
            const maker = $cells.eq(detailKeys.indexOf('メーカー名')).text().trim();
            const standard = $cells.eq(detailKeys.indexOf('規格')).text().trim();
            const grossProfitRate = $cells.eq(detailKeys.indexOf('値入率')).text().trim();
            allocationItems.push({ sourceFileName: sourceFileName, name: itemName, qty: qty, price: price, slipDate: slipDate, department: department, jan: jan, maker: maker, standard: standard, grossProfitRate: grossProfitRate });
        }
      });
      const listElement = document.getElementById('allocation-list'); $(listElement).empty();
      allocationItems.forEach(item => { $(listElement).append( `<div class="item" data-source-file-name="${item.sourceFileName || ''}" data-qty="${item.qty}" data-price="${item.price}" data-slip-date="${item.slipDate || ''}" data-department="${item.department || ''}" data-jan="${item.jan || ''}" data-maker="${item.maker || ''}" data-standard="${item.standard || ''}" data-gross-profit-rate="${item.grossProfitRate || ''}" >${item.name} (${item.qty})</div>` ); });
      if (Sortable.get(listElement)) Sortable.get(listElement).destroy();
      Sortable.create(listElement,{ group:'shared', multiDrag:true, selectedClass:'selected', animation:150 });
      renderPackets(true); new bootstrap.Tab($('#workflowTabs a[href="#step2"]')[0]).show();
    });

    function renderPackets(forceFullRender = false) {
      const container = $('#packets'); if (forceFullRender) { container.empty(); }
      const existingPacketCount = forceFullRender ? 0 : container.find('.packet').length;
      for (let i = existingPacketCount; i < packets.length; i++) {
        const name = packets[i]; const packetIndex = i;
        const packetDiv = $(`<div class="packet" data-packet-id="${packetIndex}"><h6 contenteditable data-idx="${packetIndex}">${name}</h6><div class="dropzone" data-idx="${packetIndex}"></div><div class="sum">合計: 0 円</div></div>`);
        container.append(packetDiv);
        packetDiv.find('h6').on('blur', e => {
            const newName = e.target.textContent.trim(); const idx = parseInt(e.target.dataset.idx, 10);
            if (newName && packets[idx] !== undefined) { packets[idx] = newName; }
            else if (packets[idx] !== undefined) { e.target.textContent = packets[idx]; }
        }).on('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); e.target.blur(); }});
        Sortable.create(packetDiv.find('.dropzone')[0], { group: 'shared', multiDrag: true, selectedClass: 'selected', animation: 150, onAdd: updateSums, onRemove: updateSums, sort: true });
      }
      updateSums();
    }

    function updateSums() {
      $('.packet').each(function() {
        let total = 0; $(this).find('.dropzone .item').each(function() { total += (parseFloat($(this).data('qty'))||0) * (parseFloat($(this).data('price'))||0); });
        $(this).find('.sum').text('合計: ' + total.toLocaleString() + ' 円');
      });
    }

    $('#add-packet').on('click', function() { const newPacketName = `新規パケット ${packets.length + 1}`; packets.push(newPacketName); renderPackets(); });

    $('#save-packet-config').on('click', function(){
      const currentPacketNames = []; $('#packets .packet h6').each(function() { currentPacketNames.push($(this).text().trim()); });
      packets = [...currentPacketNames]; const packetConfig = { packetNames: packets }; const jsonString = JSON.stringify(packetConfig, null, 2);
      localStorage.setItem(localStorageKey, jsonString);
      const blob = new Blob([jsonString], { type: 'application/json' }); const url = URL.createObjectURL(blob);
      const link = document.createElement('a'); link.href = url; link.download = 'packet_config.json';
      document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url);
      alert('パケット構成を保存しました。');
    });

    $('#load-packet-config').on('click', function() { $('#load-packet-config-input').click(); });
    $('#load-packet-config-input').on('change', function(e) {
        const file = e.target.files[0]; if (!file) return; const reader = new FileReader();
        reader.onload = function(event) {
            try {
                const config = JSON.parse(event.target.result);
                if (config && Array.isArray(config.packetNames)) {
                    packets = [...config.packetNames]; localStorage.setItem(localStorageKey, JSON.stringify({ packetNames: packets }));
                    $('#packets').empty(); renderPackets(true); alert('パケット構成を読み込みました。');
                } else { alert('JSONファイルの形式が正しくありません。'); }
            } catch (err) { alert('パケット構成ファイルの読み込み失敗: ' + err.message); }
        };
        reader.readAsText(file); $(this).val('');
    });

    $('#download-csv').on('click', function() {
        let csvContent = "\uFEFF";
        const header = ["取得ファイル名", "パケット名", "伝票日付", "部門", "JAN", "メーカー名", "商品名", "規格", "値入率", "数量", "単価(本体売価)", "合計金額(本体売価)"];
        csvContent += header.join(",") + "\r\n";
        $('#packets .packet').each(function() {
            const packetNameEl = $(this).find('h6'); const packetName = packetNameEl.length ? packetNameEl.text().trim().replace(/"/g, '""') : "名称未設定パケット";
            if ($(this).find('.dropzone .item').length === 0) {
                const emptyCols = Array(header.length - 2).fill('').join(','); csvContent += `,"${packetName}",${emptyCols}\r\n`;
            } else {
                $(this).find('.dropzone .item').each(function() {
                    const $item = $(this); const itemText = $item.text();
                    const sourceFileName = ($item.data('source-file-name') || '').toString().replace(/"/g, '""');
                    const qty = parseFloat($item.data('qty')) || 0; const price = parseFloat($item.data('price')) || 0; const itemTotal = qty * price;
                    const itemNameMatch = itemText.match(/(.*) \(\d+(\.\d+)?\)$/);
                    const itemName = itemNameMatch ? itemNameMatch[1].trim().replace(/"/g, '""') : itemText.trim().replace(/"/g, '""');
                    const slipDate = ($item.data('slip-date') || '').toString().replace(/"/g, '""');
                    const department = ($item.data('department') || '').toString().replace(/"/g, '""');
                    const jan = ($item.data('jan') || '').toString().replace(/"/g, '""');
                    const maker = ($item.data('maker') || '').toString().replace(/"/g, '""');
                    const standard = ($item.data('standard') || '').toString().replace(/"/g, '""');
                    const grossProfitRate = ($item.data('gross-profit-rate') || '').toString().replace(/"/g, '""');
                    const row = [`"${sourceFileName}"`, `"${packetName}"`, `"${slipDate}"`, `"${department}"`, `"${jan}"`, `"${maker}"`, `"${itemName}"`, `"${standard}"`, `"${grossProfitRate}"`, qty, price, itemTotal];
                    csvContent += row.join(",") + "\r\n";
                });
            }
        });
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob);
        const link = document.createElement("a"); link.setAttribute("href", url); link.setAttribute("download", "パケット配分結果_ファイル名付き.csv");
        document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
