<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>発注・配分ワークフロー (金額合計表示) - CYBERPUNK EDITION v3</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/datatables.net-dt@1.13.6/css/jquery.dataTables.min.css" rel="stylesheet"/>
  <link href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <style>
    body {
      padding: 20px;
      background-color: #0f0f23; /* Dark blue/purple background */
      color: #00ffcc; /* Cyan text */
      font-family: 'Share Tech Mono', monospace;
      font-size: 16px;
    }

    h1 {
      font-family: 'Orbitron', sans-serif;
      color: #ff00ff; /* Magenta */
      text-align: center;
      text-shadow: 0 0 5px #ff00ff, 0 0 10px #ff00ff, 0 0 15px #ff00ff;
      margin-bottom: 40px;
      letter-spacing: 3px;
      text-transform: uppercase;
    }

    /* Input and Select Styles */
    .form-control, .form-select {
      background-color: #202040;
      color: #00ffcc;
      border: 1px solid #7f00ff; /* Purple border */
      border-radius: 0; /* Sharp edges */
      box-shadow: inset 0 0 5px rgba(127, 0, 255, 0.5);
      transition: all 0.3s ease;
    }
    .form-control::placeholder {
      color: #00cc99;
      opacity: 0.7;
    }
    .form-control:focus, .form-select:focus {
      background-color: #25254f;
      color: #00ffff;
      border-color: #ff00ff;
      box-shadow: 0 0 8px #ff00ff, inset 0 0 8px rgba(255, 0, 255, 0.6);
      outline: none;
    }
    #file-input::file-selector-button,
    #load-packet-config-input::file-selector-button { /* Apply to both file inputs */
      font-family: 'Orbitron', sans-serif;
      background-color: #7f00ff;
      border: 1px solid #7f00ff;
      color: #ffffff;
      padding: 0.375rem 0.75rem;
      margin-right: 0.75rem;
      border-radius: 0;
      transition: all 0.3s ease;
      text-transform: uppercase;
    }
    #file-input::file-selector-button:hover,
    #load-packet-config-input::file-selector-button:hover {
      background-color: #9d00ff;
      border-color: #9d00ff;
      box-shadow: 0 0 5px #9d00ff;
    }


    /* Button Styles */
    .btn {
      font-family: 'Orbitron', sans-serif;
      border-radius: 0; /* Sharp edges */
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.3s ease;
      box-shadow: 0 0 3px rgba(0,0,0,0.5);
      padding: 0.5rem 1rem;
    }
    .btn-primary {
      background-color: #7f00ff; /* Purple */
      border-color: #7f00ff;
      color: #ffffff;
      box-shadow: 0 0 5px #7f00ff, 0 0 10px #7f00ff;
    }
    .btn-primary:hover, .btn-primary:focus {
      background-color: #9d00ff;
      border-color: #9d00ff;
      color: #ffffff;
      box-shadow: 0 0 10px #9d00ff, 0 0 15px #9d00ff, 0 0 20px #9d00ff;
    }
    .btn-success {
      background-color: #00cc00; /* Green */
      border-color: #00cc00;
      color: #0f0f23;
      box-shadow: 0 0 5px #00cc00, 0 0 10px #00cc00;
    }
    .btn-success:hover, .btn-success:focus {
      background-color: #00ff00;
      border-color: #00ff00;
      color: #0f0f23;
      box-shadow: 0 0 10px #00ff00, 0 0 15px #00ff00, 0 0 20px #00ff00;
    }
    .btn-info {
        background-color: #00aaff; /* Cyan-blue */
        border-color: #00aaff;
        color: #0f0f23;
        box-shadow: 0 0 5px #00aaff, 0 0 10px #00aaff;
    }
    .btn-info:hover, .btn-info:focus {
        background-color: #00ccff;
        border-color: #00ccff;
        color: #0f0f23;
        box-shadow: 0 0 10px #00ccff, 0 0 15px #00ccff, 0 0 20px #00ccff;
    }
    .btn-secondary {
        background-color: #505070; /* Darker grey-purple */
        border-color: #505070;
        color: #e0e0ff;
        box-shadow: 0 0 5px #505070;
    }
    .btn-secondary:hover, .btn-secondary:focus {
        background-color: #606080;
        border-color: #606080;
        color: #ffffff;
        box-shadow: 0 0 10px #606080;
    }


    /* Tab Styles */
    .nav-tabs {
      border-bottom: 2px solid #7f00ff; /* Thicker border for emphasis */
      margin-bottom: 20px;
    }
    .nav-tabs .nav-link {
      font-family: 'Orbitron', sans-serif;
      border: 1px solid transparent;
      border-bottom: none; /* Remove bottom border for inactive tabs */
      border-top-left-radius: 0;
      border-top-right-radius: 0;
      color: #00ffcc;
      background-color: transparent;
      margin-right: 2px;
      padding: 0.75rem 1.25rem;
      transition: all 0.3s ease;
      clip-path: polygon(10% 0%, 100% 0%, 90% 100%, 0% 100%); /* Angled tab shape */
    }
    .nav-tabs .nav-link:hover {
      color: #ff00ff;
      background-color: #202040;
      border-color: #7f00ff #7f00ff transparent; /* Top and side borders only */
    }
    .nav-tabs .nav-link.active {
      color: #ffffff;
      background-color: #7f00ff;
      border-color: #7f00ff #7f00ff #7f00ff;
      box-shadow: 0 0 8px #7f00ff, inset 0 3px 5px rgba(0,0,0,0.2);
      font-weight: bold;
      position: relative;
      z-index: 1; /* Ensure active tab is on top */
    }
    .tab-content {
      margin-top: 0; /* Tabs will provide separation */
      padding: 25px;
      border: 1px solid #7f00ff;
      border-top: none; /* Remove top border as tabs cover it */
      background-color: rgba(16, 16, 35, 0.85); /* Slightly transparent dark bg */
      box-shadow: inset 0 0 15px rgba(127, 0, 255, 0.4);
    }

    /* Table Controls Top */
    .table-controls-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      color: #00ffcc;
      font-family: 'Orbitron', sans-serif;
      padding: 10px;
      border: 1px dashed #404060;
      background-color: rgba(32, 32, 64, 0.3);
    }
    .table-controls-top > div {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* DataTables Styles */
    #order-table_wrapper {
      margin-top: 10px;
      background-color: transparent;
      padding: 10px;
      border: 1px solid #404060; /* Subtle border for wrapper */
    }
    #order-table {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid #7f00ff;
    }
    #order-table thead th {
      background-color: #1a1a3a;
      color: #00ffff;
      border: 1px solid #7f00ff;
      padding: 12px 10px;
      text-align: left;
      font-weight: normal;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    table.dataTable.fixedHeader-floating thead th,
    table.dataTable.fixedHeader-locked thead th { /* Style for fixed header */
        background-color: #20204f !important; /* Slightly different for fixed */
        color: #00ffff !important;
        border-bottom: 2px solid #ff00ff !important;
    }

    #order-table tbody td {
      background-color: #101028;
      color: #00ffcc;
      border: 1px solid #404060;
      padding: 10px 8px;
      transition: background-color 0.2s, color 0.2s;
    }
    #order-table tbody tr:hover td {
      background-color: #25254f;
      color: #ffffff;
      box-shadow: inset 0 0 10px rgba(0, 255, 255, 0.2);
    }
    #order-table .qty-input {
      background-color: #25254f;
      color: #00ffff;
      border: 1px solid #7f00ff;
      padding: 6px 8px;
      width: 90px;
      text-align: right;
    }
    #order-table .qty-input:focus {
      border-color: #ff00ff;
      box-shadow: 0 0 5px #ff00ff;
    }

    /* DataTables controls (pagination, search, length) */
    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter,
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_paginate {
      color: #00ffcc !important;
      margin-bottom: 15px;
      font-family: 'Share Tech Mono', monospace;
    }
    .dataTables_wrapper .dataTables_length label,
    .dataTables_wrapper .dataTables_filter label {
        display: flex;
        align-items: center;
        gap: 5px;
        color: #00ffcc !important; /* Ensure label text is styled */
    }
    .dataTables_wrapper .dataTables_length select,
    .dataTables_wrapper .dataTables_filter input {
      background-color: #202040;
      color: #00ffcc;
      border: 1px solid #7f00ff;
      border-radius: 0;
      padding: 6px 10px;
      flex-grow: 1;
    }
     .dataTables_wrapper .dataTables_length select:focus,
    .dataTables_wrapper .dataTables_filter input:focus {
      background-color: #25254f;
      color: #00ffff;
      border-color: #ff00ff;
      box-shadow: 0 0 8px #ff00ff;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button {
      font-family: 'Orbitron', sans-serif;
      color: #00ffcc !important;
      border: 1px solid #7f00ff;
      background: #202040;
      margin: 0 3px;
      border-radius: 0;
      padding: 6px 12px;
      transition: all 0.2s ease;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
      color: #ffffff !important;
      background: #7f00ff;
      border-color: #7f00ff;
      box-shadow: 0 0 8px #7f00ff;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button.current,
    .dataTables_wrapper .dataTables_paginate .paginate_button.current:hover {
      color: #ffffff !important;
      background: #ff00ff;
      border-color: #ff00ff;
      box-shadow: 0 0 10px #ff00ff;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button.disabled,
    .dataTables_wrapper .dataTables_paginate .paginate_button.disabled:hover {
      color: #555577 !important;
      background: #151530;
      border-color: #404060;
      box-shadow: none;
      opacity: 0.6;
    }

    #order-table_wrapper .top-pagination { /* Style for cloned pagination */
      display: inline-block;
      margin: 0 10px;
    }
    #order-table_wrapper .dataTables_length,
    #order-table_wrapper .dataTables_filter,
    #order-table_wrapper .top-pagination {
       margin-bottom: 0.5em;
    }
    .dataTables_wrapper .row:first-child { /* Target top row of DataTable controls */
        margin-bottom: 10px;
        align-items: center;
    }

    /* Step 2: Allocation Styles */
    #step2 > .d-flex { /* Top control bar for step 2 */
        padding: 10px;
        border: 1px dashed #404060;
        background-color: rgba(32, 32, 64, 0.3);
        margin-bottom: 15px;
    }
    #step2 h5 {
      font-family: 'Orbitron', sans-serif;
      color: #ff00ff;
      text-shadow: 0 0 3px #ff00ff;
      text-transform: uppercase;
      margin-bottom: 0; /* Adjusted for flex alignment */
    }
    #step2 h6 { /* For "商品リスト" and packet titles */
      font-family: 'Orbitron', sans-serif;
      color: #00ffff;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .drag-drop-list, .dropzone {
      min-height: 250px;
      border: 2px dashed #7f00ff;
      padding: 15px;
      background-color: rgba(32, 32, 64, 0.6);
      overflow-y: auto;
      max-height: 450px; /* Or adjust as needed */
      box-shadow: inset 0 0 10px rgba(127,0,255,0.3);
    }
    #step2 .col-9 { /* Packet container area */
        max-height: calc(100vh - 350px); /* Adjust based on your layout */
        overflow-y: auto;
        padding-bottom: 15px;
    }


    .item {
      padding: 10px 12px;
      margin: 8px 0;
      background: #252545;
      border: 1px solid #404060;
      color: #00ffcc;
      cursor: grab;
      transition: background-color 0.2s, border-color 0.2s, box-shadow 0.2s;
      word-break: break-word;
      font-size: 0.95em;
      position: relative; /* For potential pseudo-elements */
    }
    .item:hover {
      border-color: #00ffff;
      background-color: #303055;
      box-shadow: 0 0 5px rgba(0, 255, 255, 0.5);
    }
    .item.selected, .item.sortable-chosen, .item.sortable-ghost {
      background: #400080;
      border-color: #ff00ff;
      color: #ffffff;
      box-shadow: 0 0 10px #ff00ff, inset 0 0 5px rgba(255,0,255,0.5);
    }

    .packet-container {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .packet {
      border: 1px solid #7f00ff;
      border-radius: 0;
      padding: 15px;
      width: 260px;
      background-color: #1a1a3a;
      box-shadow: 0 0 12px rgba(127, 0, 255, 0.4);
      display: flex;
      flex-direction: column;
    }
    .packet h6 {
      margin: 0 0 15px;
      cursor: text;
      color: #ff00ff;
      padding: 8px;
      border-bottom: 1px solid #7f00ff;
      transition: color 0.2s, background-color 0.2s;
      text-align: center;
    }
    .packet h6:focus {
      outline: none;
      background-color: #25254f;
      color: #ffffff;
      box-shadow: inset 0 0 8px #ff00ff;
    }
    .packet .dropzone {
        flex-grow: 1; /* Allow dropzone to fill space */
        min-height: 150px; /* Ensure a minimum drop area */
    }
    .packet .sum {
      margin-top: 15px;
      font-weight: normal;
      color: #00ffff;
      text-align: right;
      padding-top: 10px;
      border-top: 1px dashed #404060;
      font-size: 1.1em;
    }

    #add-packet { margin-top: 0; } /* Adjusted for flex layout */

    /* Scrollbar styling (Webkit browsers) */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    ::-webkit-scrollbar-track {
      background: #101028;
      border-radius: 0;
      border: 1px solid #202040;
    }
    ::-webkit-scrollbar-thumb {
      background: #7f00ff;
      border-radius: 0;
      border: 1px solid #9d00ff;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #9d00ff;
      box-shadow: 0 0 5px #9d00ff;
    }

    /* General focus outline for accessibility, styled */
    *:focus-visible {
        outline: 2px solid #ff00ff !important;
        outline-offset: 2px;
        box-shadow: 0 0 10px #ff00ff !important;
    }
    .btn:focus-visible { /* Button specific focus */
        outline: 2px solid #00ffff !important;
        box-shadow: 0 0 10px #00ffff !important;
    }

  </style>
</head>
<body>
  <h1>発注・配分ワークフロー (金額合計表示)</h1>
  <input type="file" id="file-input" accept=".csv,.xlsx,.xls" class="form-control mb-3" multiple/>
  <ul class="nav nav-tabs" id="workflowTabs">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#step1">ステップ1: 発注数量入力</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#step2">ステップ2: パケット配分</a></li>
  </ul>
  <div class="tab-content step-content">
    <div class="tab-pane fade show active" id="step1">
      <div class="table-controls-top">
        <div>
          対象店舗:
          <select id="store-select" class="form-select d-inline-block" style="width:auto;"></select>
        </div>
        <div>
          <button id="download-order-list-csv" class="btn btn-info btn-sm me-2">全発注リストダウンロード(CSV)</button>
          <button id="to-step2" class="btn btn-primary">次へ</button>
        </div>
      </div>
      <table id="order-table" class="display" style="width:100%">
        <thead>
          <tr>
            <th>取得ファイル名</th>
            <th>伝票日付</th><th>チラシ日</th><th>売価開始日</th><th>売価終了日</th>
            <th>重要度</th><th>部門</th><th>JAN</th><th>メーカー名</th><th>商品名</th>
            <th>規格</th><th>発注単位</th><th>原価</th><th>本体売価</th><th>総額売価</th>
            <th>税率</th><th>値入率</th><th>備考</th><th>提案数量</th><th>発注数量</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="tab-pane fade" id="step2">
      <div class="d-flex justify-content-between align-items-center">
        <h5>発注数量をドラッグ＆ドロップでパケットへ配分</h5>
        <div class="d-flex align-items-center gap-2">
          <button id="add-packet" class="btn btn-success btn-sm">パケット追加</button>
          <button id="load-packet-config" class="btn btn-info btn-sm">構成読込</button>
          <input type="file" id="load-packet-config-input" accept=".json" style="display: none;">
          <button id="save-packet-config" class="btn btn-primary btn-sm">構成保存</button>
          <button id="download-csv" class="btn btn-secondary btn-sm">CSVダウンロード</button>
        </div>
      </div>
      <div class="row mt-3">
        <div class="col-3"><h6>商品リスト</h6><div id="allocation-list" class="drag-drop-list"></div></div>
        <div class="col-9"><div class="packet-container" id="packets"></div></div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/datatables.net@1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/plugins/SortableMultiDrag.min.js"></script>

  <script>
    if (typeof Sortable !== 'undefined' && typeof Sortable.MultiDrag === 'function') {
        Sortable.mount(new Sortable.MultiDrag());
    }
    const detailKeys = ['取得ファイル名', '伝票日付','チラシ日','売価開始日','売価終了日','重要度','部門','JAN','メーカー名','商品名','規格','発注単位','原価','本体売価','総額売価','税率','値入率','備考'];
    let dataRows = [], storeCols = [], orderTable;
    let allocationItems = []; // Array of item objects in the source list
    let packets = []; // Array of packet objects: { name: string, items: [] }
    const localStorageKey = 'workflowPacketNamesConfigCyber_v3'; // Key for packet names only
    
    initializePacketsFromStorage();

    $(document).ready(function() {
        orderTable = $('#order-table').DataTable({
            columns: detailKeys.map(() => ({})).concat([{}, {}]),
            dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rt<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
            fixedHeader: true,
            language: { 
                "sEmptyTable":     "テーブルにデータがありません",
                "sInfo":           "全 _TOTAL_ 件中 _START_ から _END_ まで表示",
                "sInfoEmpty":      "表示するデータがありません",
                "sInfoFiltered":   "(_MAX_ 件以上のデータから抽出)",
                "sInfoPostFix":    "",
                "sInfoThousands":  ",",
                "sLengthMenu":     "表示件数: _MENU_",
                "sLoadingRecords": "ロード中...",
                "sProcessing":     "処理中...",
                "sSearch":         "検索:",
                "sZeroRecords":    "該当するデータが見つかりません",
                "oPaginate": {
                    "sFirst":    "先頭",
                    "sLast":     "最終",
                    "sNext":     "次",
                    "sPrevious": "前"
                },
                "oAria": {
                    "sSortAscending":  ": 列を昇順に並べ替えるにはアクティブにする",
                    "sSortDescending": ": 列を降順に並べ替えるにはアクティブにする"
                }
            }
        });
        
        orderTable.on('init.dt', function() {
            var $tableWrapper = $(this).closest('.dataTables_wrapper');
            var $paginateBottom = $tableWrapper.find('.dataTables_paginate');
            var $topPaginationContainer = $tableWrapper.find('.top-pagination-custom-container');
            if (!$topPaginationContainer.length) {
                $topPaginationContainer = $('<div class="col-sm-12 col-md-auto top-pagination-custom-container d-flex justify-content-center justify-content-md-start"></div>');
                const $lengthFilterRow = $tableWrapper.find('.row').first();
                if($lengthFilterRow.find('.dataTables_filter').length) {
                    $lengthFilterRow.find('.dataTables_filter').parent().after($topPaginationContainer.parent());
                } else if ($lengthFilterRow.find('.dataTables_length').length) {
                     $lengthFilterRow.find('.dataTables_length').parent().after($topPaginationContainer.parent());
                } else {
                    $lengthFilterRow.append($topPaginationContainer);
                }
            }
            if ($paginateBottom.length) {
                $topPaginationContainer.empty().append($paginateBottom.clone(true).addClass('top-pagination'));
            }
        });
        
        orderTable.on('draw.dt', function () {
            var $tableWrapper = $(this).closest('.dataTables_wrapper');
            var $paginateBottom = $tableWrapper.find('.dataTables_paginate:not(.top-pagination)');
            var $topPaginationContainer = $tableWrapper.find('.top-pagination-custom-container');
            if ($paginateBottom.length && $topPaginationContainer.length) {
                 $topPaginationContainer.empty().append($paginateBottom.clone(true).addClass('top-pagination'));
            }
        });

        $('a[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
            const targetTab = $(e.target).attr("href");
            if (orderTable && $.fn.DataTable.isDataTable('#order-table')) {
                var fh = orderTable.fixedHeader;
                if (fh) { 
                    if (targetTab === "#step1") {
                        fh.enable(); 
                        fh.adjust(); 
                    } else {
                        fh.disable(); 
                    }
                }
                $($.fn.dataTable.tables(true)).DataTable().columns.adjust();
            }
            if (targetTab === "#step2") {
                renderAllocationList();
                renderPackets(false); 
            }
        });

        $('#download-order-list-csv').off('click').on('click', function() {
            // (CSV download logic from previous code - no change needed here based on request)
            if (!orderTable || !$('#store-select').val()) {
                alert('まず店舗を選択し、データを表示してください。'); return;
            }
            let csvContent = "\uFEFF";
            const csvHeader = [...detailKeys, "提案数量", "発注数量"];
            csvContent += csvHeader.map(h => `"${h.replace(/"/g, '""')}"`).join(",") + "\r\n";
            orderTable.rows({ search: 'applied' }).nodes().to$().each(function() {
                const $row = $(this); const rowData = [];
                $row.find('td').each(function(index, cell) {
                    if (index < csvHeader.length - 1) {
                        rowData.push(`"${$(cell).text().trim().replace(/"/g, '""')}"`);
                    } else { 
                        const qtyInputVal = $(cell).find('input.qty-input').val();
                        rowData.push(qtyInputVal !== undefined ? `"${String(qtyInputVal).replace(/"/g, '""')}"` : '""');
                    }
                });
                csvContent += rowData.join(",") + "\r\n";
            });
            const selectedStore = $('#store-select option:selected').text() || "全店舗";
            const fileName = `発注リスト_${selectedStore.replace(/\s/g, '_')}_${new Date().toISOString().slice(0,10)}.csv`;
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob); const link = document.createElement("a");
            link.setAttribute("href", url); link.setAttribute("download", fileName);
            document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url);
        });

        $('#file-input').off('change').on('change', function(e) {
          // (File input logic from previous code - no change needed here based on request)
          const files = e.target.files;
          if (!files || files.length === 0) { return; }
          const filePromises = Array.from(files).map(file => {
            return new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = ev => {
                try {
                  let parsedFileContent = [];
                  const keysToNotEmpty = ['JAN', 'メーカー名', '商品名', '規格', '発注単位', '原価', '本体売価', '総額売価'];
                  if (file.name.endsWith('.csv')) {
                    Papa.parse(ev.target.result, {
                      header: true, skipEmptyLines: true, dynamicTyping: true,
                      complete: res => {
                        if (res.data && res.data.length > 0 && typeof res.data[0] === 'object' && res.data[0] !== null) {
                          parsedFileContent = res.data.map(row => ({ ...row, '取得ファイル名': file.name }))
                            .filter(obj => keysToNotEmpty.some(key => obj[key] != null && String(obj[key]).trim() !== ''));
                        }
                        resolve(parsedFileContent);
                      },
                      error: (err) => { console.error("CSV Parse Error for " + file.name + ":", err); resolve([]); }
                    });
                  } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    const wb = XLSX.read(ev.target.result, { type: 'binary' });
                    const targetSheetName = "新データ入力"; let ws;
                    if (wb.SheetNames.includes(targetSheetName)) { ws = wb.Sheets[targetSheetName]; }
                    else if (wb.SheetNames.length > 0) { ws = wb.Sheets[wb.SheetNames[0]]; console.warn(`Sheet "${targetSheetName}" not found in ${file.name}, using first sheet "${wb.SheetNames[0]}"`);}
                    else { resolve([]); return; }

                    const rowsAsArrays = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '', raw: false });
                    let headerRowIndex = -1; let actualHeaders = [];
                    const headerCandidateIndices = [5, 6, 7, 0, 1, 2, 3, 4];
                    let bestMatchCount = 0;

                    for (const idx of headerCandidateIndices) {
                        if (idx < rowsAsArrays.length) {
                            const rowCells = (rowsAsArrays[idx] || []).map(cell => String(cell || '').trim());
                            let matchCount = 0;
                            const detailKeysLower = detailKeys.map(k => k.toLowerCase());
                            rowCells.forEach(rc => { if (detailKeysLower.includes(rc.toLowerCase())) matchCount++; });

                            if (matchCount > bestMatchCount && matchCount >= 3) {
                                bestMatchCount = matchCount;
                                headerRowIndex = idx;
                                actualHeaders = rowCells;
                            }
                        }
                    }
                     if (headerRowIndex === -1 && rowsAsArrays.length > 0) {
                        headerRowIndex = 0;
                        actualHeaders = (rowsAsArrays[0] || []).map(cell => String(cell || '').trim());
                    }
                    if (headerRowIndex === -1) { resolve([]); return; }

                    const dataRowsOnly = rowsAsArrays.slice(headerRowIndex + 1);
                    parsedFileContent = dataRowsOnly.map(rowArray => {
                      const obj = { '取得ファイル名': file.name };
                      if (Array.isArray(rowArray)) {
                        actualHeaders.forEach((header, index) => {
                          if (header && header.trim() !== "") { obj[header.trim()] = (rowArray[index] !== undefined && rowArray[index] !== null) ? String(rowArray[index]) : ''; }
                        });
                      }
                      return obj;
                    }).filter(obj => {
                        return keysToNotEmpty.some(key => obj[key] != null && String(obj[key]).trim() !== '');
                    });
                    resolve(parsedFileContent);
                  } else { resolve([]); }
                } catch (error) { console.error("File processing error for " + file.name + ":", error); reject(error); }
              };
              reader.onerror = err => { console.error("FileReader error for " + file.name + ":", err); reject(err); };
              if (file.name.endsWith('.csv')) { reader.readAsText(file); }
              else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) { reader.readAsBinaryString(file); }
              else { alert("未対応形式: " + file.name); resolve([]); }
            });
          });
          Promise.all(filePromises).then(results => {
            const allParsedData = results.reduce((acc, data) => acc.concat(data), []);
            if (allParsedData.length === 0 && files.length > 0) { alert("読み込みに成功しましたが、有効なデータが見つかりませんでした。"); }
            handle(allParsedData);
          }).catch((err) => { console.error("Overall file processing error:", err); alert("一部または全てのファイルの処理中にエラーが発生しました。"); handle([]); });
          $(this).val('');
        });

        $('#store-select').off('change').on('change', function(){
          // (Store select logic from previous code - no change needed here based on request)
          const store = this.value; 
          orderTable.clear();
          if(!store || !dataRows || dataRows.length === 0){ orderTable.draw(); return; }
          dataRows.forEach((r, index) => {
            if (typeof r !== 'object' || r === null) return;
            const proposalQtyRaw = r[store];
            const proposalQty = (proposalQtyRaw != null && !isNaN(parseFloat(String(proposalQtyRaw).replace(/,/g, '')))) ? parseFloat(String(proposalQtyRaw).replace(/,/g, '')) : 0;
            
            const unitPrice = parseFloat(String(r['本体売価'] || 0).replace(/,/g, '')) || 0; 
            const orderUnit = parseFloat(String(r['発注単位'] || 1).replace(/,/g, '')) || 1;

            let initialOrderQty = proposalQty < 0 ? 0 : proposalQty;
            if (orderUnit > 0 && initialOrderQty > 0 && initialOrderQty % orderUnit !== 0) initialOrderQty = Math.ceil(initialOrderQty / orderUnit) * orderUnit;
            
            const orderQtyInput = `<input type="number" class="form-control qty-input" min="0" step="${orderUnit > 0 ? orderUnit : 1}" value="${initialOrderQty}" data-price="${unitPrice}" data-order-unit="${orderUnit}" data-row-original-index="${index}" />`;
            
            const rowData = detailKeys.map(k => (r[k] !== undefined && r[k] !== null) ? String(r[k]) : '');
            rowData.push(proposalQty, orderQtyInput); 
            orderTable.row.add(rowData);
          });
          orderTable.draw();
        });

        $(document).off('input change blur', '#order-table tbody .qty-input').on('input change blur', '#order-table tbody .qty-input', function(event) {
            // (Qty input logic from previous code - no change needed here based on request)
            const $input = $(this); const orderUnit = parseFloat($input.data('order-unit')) || 1; let currentQty = parseFloat($input.val());
            if (isNaN(currentQty)) { if (event.type === 'blur' && $input.val().trim() === '') $input.val(0); return; }
            if (currentQty < 0) { currentQty = 0; $input.val(0); }
            if (event.type === 'blur' || event.type === 'change') {
                if (orderUnit > 0 && currentQty > 0) { 
                    const adj = Math.ceil(currentQty / orderUnit) * orderUnit; 
                    if (parseFloat($input.val()) !== adj) $input.val(adj); 
                } else if (currentQty === 0) { 
                    $input.val(0); 
                }
            }
        });

        $('#to-step2').off('click').on('click', function(){
          allocationItems = []; 
          orderTable.rows({ search: 'applied' }).nodes().to$().each(function(idx) {
            const $row = $(this); const $cells = $row.find('td'); if ($cells.length === 0) return;
            
            const sourceFileName = $cells.eq(detailKeys.indexOf('取得ファイル名')).text().trim();
            const itemName = $cells.eq(detailKeys.indexOf('商品名')).text().trim();
            const $input = $cells.last().find('input.qty-input'); if ($input.length === 0) return;
            
            const qty = parseFloat($input.val()) || 0; 
            const price = parseFloat($input.data('price')) || 0;
            
            if(qty > 0 && itemName && !isNaN(price)) {
                const slipDate = $cells.eq(detailKeys.indexOf('伝票日付')).text().trim();
                const department = $cells.eq(detailKeys.indexOf('部門')).text().trim();
                const jan = $cells.eq(detailKeys.indexOf('JAN')).text().trim();
                const maker = $cells.eq(detailKeys.indexOf('メーカー名')).text().trim();
                const standard = $cells.eq(detailKeys.indexOf('規格')).text().trim();
                const grossProfitRate = $cells.eq(detailKeys.indexOf('値入率')).text().trim();
                const originalDataIndex = $input.data('row-original-index') !== undefined ? $input.data('row-original-index') : idx;
                const uniqueId = `item_${jan || ('nojancode' + Math.random().toString(36).substr(2, 5))}_${originalDataIndex}_${Date.now()}`;

                allocationItems.push({ 
                    id: uniqueId, 
                    sourceFileName: sourceFileName, name: itemName, qty: qty, price: price, 
                    slipDate: slipDate, department: department, jan: jan, maker: maker, 
                    standard: standard, grossProfitRate: grossProfitRate 
                });
            }
          });
          // Clear items from existing packets before moving to step 2 if packets were loaded from config
          packets.forEach(p => p.items = []); 

          renderAllocationList(); 
          renderPackets(true);
          new bootstrap.Tab($('#workflowTabs a[href="#step2"]')[0]).show();
        });

        $('#add-packet').off('click').on('click', function() { 
            const newPacketName = `新規パケット ${packets.length + 1}`; 
            packets.push({ name: newPacketName, items: [] }); 
            renderPackets();
        });

        $('#save-packet-config').off('click').on('click', function(){
          const packetNamesToSave = []; 
          $('#packets .packet h6').each(function() { 
              packetNamesToSave.push($(this).text().trim()); 
          });
          // Update the names in the main `packets` array before saving
          packets.forEach((packet, index) => {
              if (packetNamesToSave[index]) {
                  packet.name = packetNamesToSave[index];
              }
          });
          // Save only the names
          const configToSave = { packetNames: packets.map(p => p.name) };
          const jsonString = JSON.stringify(configToSave, null, 2);
          localStorage.setItem(localStorageKey, jsonString);
          
          const blob = new Blob([jsonString], { type: 'application/json' }); 
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a'); 
          link.href = url; 
          link.download = 'packet_names_config.json';
          document.body.appendChild(link); 
          link.click(); 
          document.body.removeChild(link); 
          URL.revokeObjectURL(url);
          alert('パケット構成（名前のみ）をローカルストレージとファイルに保存しました。');
        });

        $('#load-packet-config').off('click').on('click', function() { $('#load-packet-config-input').click(); });
        $('#load-packet-config-input').off('change').on('change', function(e) {
            const file = e.target.files[0]; if (!file) return; const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const loadedConfig = JSON.parse(event.target.result);
                    if (loadedConfig && Array.isArray(loadedConfig.packetNames)) {
                        // Rebuild packets array with loaded names and empty items
                        packets = loadedConfig.packetNames.map(name => ({ name: name, items: [] }));
                        localStorage.setItem(localStorageKey, JSON.stringify({ packetNames: loadedConfig.packetNames }));
                        // Items in allocation list remain. Packets are reset.
                        renderAllocationList(); // Keep current allocation list
                        renderPackets(true);    // Render new empty packets
                        alert('パケット構成（名前のみ）を読み込みました。');
                    } else { alert('JSONファイルの形式が正しくありません。packetNames配列が必要です。'); }
                } catch (err) { alert('パケット構成ファイルの読み込み失敗: ' + err.message); }
            };
            reader.readAsText(file); $(this).val('');
        });

        $('#download-csv').off('click').on('click', function() { 
            // (CSV download logic for packet items from previous code - no change needed here based on request)
            let csvContent = "\uFEFF";
            const header = ["取得ファイル名", "パケット名", "伝票日付", "部門", "JAN", "メーカー名", "商品名", "規格", "値入率", "数量", "単価(本体売価)", "合計金額(本体売価)"];
            csvContent += header.map(h => `"${h.replace(/"/g, '""')}"`).join(",") + "\r\n";
            
            packets.forEach(packet => {
                const packetName = (packet.name || "名称未設定パケット").replace(/"/g, '""');
                if (!packet.items || packet.items.length === 0) {
                    // Optionally add a row for empty packets
                } else {
                    packet.items.forEach(item => {
                        const itemTotal = (item.qty || 0) * (item.price || 0);
                        const row = [
                            `"${(item.sourceFileName || '').replace(/"/g, '""')}"`, `"${packetName}"`, 
                            `"${(item.slipDate || '').replace(/"/g, '""')}"`, `"${(item.department || '').replace(/"/g, '""')}"`,
                            `"${(item.jan || '').replace(/"/g, '""')}"`, `"${(item.maker || '').replace(/"/g, '""')}"`,
                            `"${(item.name || '').replace(/"/g, '""')}"`, `"${(item.standard || '').replace(/"/g, '""')}"`,
                            `"${(item.grossProfitRate || '').replace(/"/g, '""')}"`, 
                            item.qty || 0, item.price || 0, itemTotal
                        ];
                        csvContent += row.join(",") + "\r\n";
                    });
                }
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); 
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a"); 
            link.setAttribute("href", url); 
            link.setAttribute("download", "パケット配分結果_詳細.csv");
            document.body.appendChild(link); 
            link.click(); 
            document.body.removeChild(link); 
            URL.revokeObjectURL(url);
        });
    }); // End of $(document).ready()


    function initializePacketsFromStorage() {
        const savedPacketConfigJson = localStorage.getItem(localStorageKey);
        if (savedPacketConfigJson) {
            try {
                const savedConfig = JSON.parse(savedPacketConfigJson);
                // Expect an object like { packetNames: ["Name1", "Name2"] }
                if (savedConfig && Array.isArray(savedConfig.packetNames)) {
                    packets = savedConfig.packetNames.map(name => ({ name: name, items: [] }));
                } else { 
                    // Default if format is wrong or 'packetNames' is not an array
                    packets = [{name:'パケットA', items:[]},{name:'パケットB', items:[]},{name:'パケットC', items:[]}]; 
                }
            } catch (e) { // Error parsing JSON
                packets = [{name:'パケットA', items:[]},{name:'パケットB', items:[]},{name:'パケットC', items:[]}]; 
                localStorage.removeItem(localStorageKey); // Clear corrupted data
            }
        } else { 
            // Default if no saved config
            packets = [{name:'パケットA', items:[]},{name:'パケットB', items:[]},{name:'パケットC', items:[]}]; 
        }
    }

    const handle = data => {
        // (handle logic from previous code - no change needed here based on request)
        if (!data || data.length === 0) {
          dataRows = []; storeCols = []; 
          $('#store-select').empty().append('<option value="">--選択--</option>'); 
          if (orderTable) orderTable.clear().draw();
          return;
        }
        dataRows = data; 
        const allFileKeys = new Set();
        dataRows.forEach(row => { 
            if (typeof row === 'object' && row !== null) {
                Object.keys(row).forEach(key => allFileKeys.add(String(key).trim())); 
            }
        });
        
        storeCols = [];
        const detailKeysLower = detailKeys.map(dk => dk.toLowerCase());
        allFileKeys.forEach(key => { 
            if (!detailKeysLower.includes(key.toLowerCase()) && key !== "") {
                storeCols.push(key); 
            }
        });
        
        const $storeSelect = $('#store-select').empty().append('<option value="">--店舗選択--</option>');
        if (storeCols.length > 0) {
            storeCols.sort().forEach(s => $storeSelect.append(`<option value="${s}">${s}</option>`));
        }
        
        if (orderTable) orderTable.clear().draw(); 
      };

    function renderAllocationList() {
        const listElement = document.getElementById('allocation-list');
        $(listElement).empty();
        allocationItems.forEach(item => {
            $(listElement).append(
                `<div class="item" 
                      data-id="${item.id}"
                      data-source-file-name="${item.sourceFileName || ''}" 
                      data-name="${item.name || ''}"
                      data-qty="${item.qty}" 
                      data-price="${item.price}" 
                      data-slip-date="${item.slipDate || ''}" 
                      data-department="${item.department || ''}" 
                      data-jan="${item.jan || ''}" 
                      data-maker="${item.maker || ''}" 
                      data-standard="${item.standard || ''}" 
                      data-gross-profit-rate="${item.grossProfitRate || ''}" 
                 >${item.name} (${item.qty})</div>`
            );
        });

        if (Sortable.get(listElement)) { Sortable.get(listElement).destroy(); }
        Sortable.create(listElement, {
            group: 'shared', 
            multiDrag: true,
            selectedClass: 'selected',
            animation: 150,
            onEnd: handleSortableEndEvent // This function will manage data arrays
        });
    }
    
    function renderPackets(forceFullRender = false) {
      const container = $('#packets');
      if (forceFullRender) {
          container.find('.dropzone').each(function() { 
              if (Sortable.get(this)) { Sortable.get(this).destroy(); } 
          });
          container.empty();
      }

      packets.forEach((packetData, packetIndex) => {
        let packetDiv = container.find(`.packet[data-packet-idx="${packetIndex}"]`);
        if (!packetDiv.length || forceFullRender) {
           if (packetDiv.length && forceFullRender) packetDiv.remove();
           packetDiv = $(
               `<div class="packet" data-packet-idx="${packetIndex}">
                   <h6 contenteditable data-idx="${packetIndex}">${packetData.name}</h6>
                   <div class="dropzone" data-idx="${packetIndex}" id="dropzone-packet-${packetIndex}"></div>
                   <div class="sum">合計: 0 円</div>
                </div>`
           );
           container.append(packetDiv);
           packetDiv.find('h6').on('blur', e => {
            const newName = e.target.textContent.trim(); 
            const idx = parseInt(e.target.dataset.idx, 10);
            if (newName && packets[idx]) { 
                packets[idx].name = newName; 
            } else if (packets[idx]) { 
                e.target.textContent = packets[idx].name; 
            }
           }).on('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); e.target.blur(); }});
        } else {
           packetDiv.find(`h6[data-idx="${packetIndex}"]`).text(packetData.name);
        }
        
        const dropzoneElement = packetDiv.find(`.dropzone[data-idx="${packetIndex}"]`)[0];
        if (Sortable.get(dropzoneElement)) { Sortable.get(dropzoneElement).destroy(); }
        
        Sortable.create(dropzoneElement, { 
            group: 'shared', 
            multiDrag: true, 
            selectedClass: 'selected', 
            animation: 150, 
            onEnd: handleSortableEndEvent // This function will manage data arrays
        });
        
        $(dropzoneElement).empty(); // Clear before re-rendering items from the `packets` array
        (packetData.items || []).forEach(item => {
            $(dropzoneElement).append(
                 `<div class="item" 
                      data-id="${item.id}"
                      data-source-file-name="${item.sourceFileName || ''}" 
                      data-name="${item.name || ''}"
                      data-qty="${item.qty}" 
                      data-price="${item.price}" 
                      data-slip-date="${item.slipDate || ''}" 
                      data-department="${item.department || ''}" 
                      data-jan="${item.jan || ''}" 
                      data-maker="${item.maker || ''}" 
                      data-standard="${item.standard || ''}" 
                      data-gross-profit-rate="${item.grossProfitRate || ''}" 
                 >${item.name} (${item.qty})</div>`
            );
        });
      });
      if (!forceFullRender) {
        container.find('.packet').each(function() {
            const currentPacketIdx = parseInt($(this).data('packet-idx'));
            if (currentPacketIdx >= packets.length) { 
                if (Sortable.get($(this).find('.dropzone')[0])) { 
                    Sortable.get($(this).find('.dropzone')[0]).destroy(); 
                }
                $(this).remove();
            }
        });
      }
      updateSums();
    }

    function handleSortableEndEvent(evt) {
        const itemEl = evt.item;
        const itemId = $(itemEl).data('id');
        let movedItemData;

        // Remove item from its original JavaScript array
        if (evt.from.id === 'allocation-list') {
            const itemIndex = allocationItems.findIndex(it => it.id === itemId);
            if (itemIndex > -1) {
                movedItemData = allocationItems.splice(itemIndex, 1)[0];
            }
        } else { // Came from another packet's dropzone
            const fromPacketIndex = $(evt.from).data('idx');
            if (packets[fromPacketIndex] && packets[fromPacketIndex].items) {
                const itemIndex = packets[fromPacketIndex].items.findIndex(it => it.id === itemId);
                if (itemIndex > -1) {
                    movedItemData = packets[fromPacketIndex].items.splice(itemIndex, 1)[0];
                }
            }
        }

        // Add item to its new JavaScript array at the correct position
        if (movedItemData) {
            if (evt.to.id === 'allocation-list') {
                const newDomIndex = Array.from(evt.to.children).indexOf(itemEl);
                allocationItems.splice(newDomIndex, 0, movedItemData);
            } else { // Moving to a packet's dropzone
                const toPacketIndex = $(evt.to).data('idx');
                if (packets[toPacketIndex]) {
                    if (!packets[toPacketIndex].items) packets[toPacketIndex].items = [];
                    const newDomIndex = Array.from(evt.to.children).indexOf(itemEl);
                    packets[toPacketIndex].items.splice(newDomIndex, 0, movedItemData);
                }
            }
        } else {
            // console.warn("Could not find movedItemData for item ID:", itemId, "from:", evt.from.id);
        }
        updateSums();
    }

    function updateSums() {
      $('.packet').each(function(idx) {
        let total = 0; 
        const packetIndex = $(this).data('packet-idx'); 
        if (packets[packetIndex] && packets[packetIndex].items) {
            packets[packetIndex].items.forEach(item => {
                total += (parseFloat(item.qty) || 0) * (parseFloat(item.price) || 0);
            });
        }
        $(this).find('.sum').text('合計: ' + total.toLocaleString() + ' 円');
      });
    }
  </script>
</body>
</html>
